<!DOCTYPE html>
<html lang="kr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수북이 쌓이는 곳</title>
    <style>
        .book_info {
            width: 300px;
        }
    </style>
</head>
<body>
    <a href="/"><h1>Home</h1></a>
    <br>
<% if(user) { %>
    <%=user.user_name%> (<%=user.user_id%>)님 환영합니다. <br>
    <a href="/user/info">회원정보</a> | <a href="/logout">로그아웃</a>
    <p></p>
    <h4>기능</h4>
    <form action="/book/search" id="search_book_form" method="post">
        ISBN : <input type="text" name="isbn" value="9788915104440">
        <button type="button" id="search_book">책 찾기</button>
    </form>
    <div class="book_info" style="display:none;">
        <div class="book_image">
            <img src="" alt="">
        </div>
        <div class="book_subinfo">
            <div class="book_title"></div>
            <div class="book_isbn">ISBN : <span></span></div>
            <div class="book_author">저자 : <span></span></div>
            <div class="book_translator">번역 : <span></span></div>
            <div class="book_publisher">출판사 : <span></span></div>
            <div class="book_regdate"></div>
            <div class="book_link"><a href="" target="_blank">Daum 책 소개</a></div>
            <div class="book_button">
                <button id="add_book">보유하고 있어요.</button>
            </div>
        </div>
        <div class="book_desc"></div>
    </div>
    <ul class="book_list">
        <li>
            <img src="" alt="">
            <span class="list_title"></span>
        </li>
    </ul>
    <script>
        let isbn;
        function init() {
            get_list();
        }
        function ax_fetch_post(url, data, callback) {
            fetch(url, {
                method: 'POST',
                body: data,
            })
            .then(response => response.json())
            .then(response => callback(response))
            .catch(error => console.error);
        }
        function get_list() {
            let form_data = new FormData();
            let url = '/book/list';
            ax_fetch_post(url, form_data, function(res) {
                console.log(res);
                let bhtml = '';
                res.data.forEach(function(v, k) {
                    console.log(k);
                    bhtml += `<li>
                                <img src="${v.thumbnail}" alt="">
                                <span class="list_title">${v.title}</span>
                            </li>`;
                });
                document.querySelector('.book_list').innerHTML = bhtml;
            });
        }
        document.querySelector('#search_book').addEventListener('click', function(e) {
            e.preventDefault();
            // form 데이터 처리
            let form_element = document.querySelector('#search_book_form');
            let form_data = new FormData(form_element);
            let url = form_element.action;

            ax_fetch_post(url, form_data, function(res) {
                console.log(res);
                isbn = res.data.isbn13;
                document.querySelector('.book_image img').src = res.data.thumbnail;
                document.querySelector('.book_title').textContent = res.data.title;
                document.querySelector('.book_isbn span').textContent = res.data.isbn13;
                document.querySelector('.book_author span').textContent = res.data.authors;
                document.querySelector('.book_translator span').textContent = res.data.translators;
                document.querySelector('.book_publisher span').textContent = res.data.publisher;
                document.querySelector('.book_regdate').textContent = res.data.regdate;
                document.querySelector('.book_link a').href = res.data.daum;
                document.querySelector('.book_desc').innerHTML = res.data.contents.replace(/(?:\r\n|\r|\n)/g, '<br/>');
                // console.log(res.data.contents.replace(/(?:\r\n|\r|\n)/g, '<br/>'));
                document.querySelector('.book_info').style.display = 'block';
            });
        });
        document.querySelector('#add_book').addEventListener('click', function(e) {
            if(!isbn) {
                alert('책이 없어요...');
                return false;
            }
            e.preventDefault();
            let form_data = new FormData();
            form_data.append('isbn', isbn);
            let url = '/book/add';
            ax_fetch_post(url, form_data, function(res) {
                isbn = '';
                console.log(res);
                document.querySelector('.book_info').style.display = 'none';
                get_list();
            });
        });
        init();
    </script>
<% } else { %>
    로그인 후 이용하세요. <br><br>
    <!-- <a href="/auth/guest" id="guest">비회원</a><br><br> -->
    <!-- <a href="/auth/facebook">Facebook</a><br><br> -->
    <!-- <a href="/auth/google">Google</a><br><br> -->
    <a href="/auth/kakao">Kakao</a><br><br>
    <!-- <a href="/auth/naver">Naver</a><br><br> -->
    <!-- <a href="/verify/google/request">Google Token 요청</a><br><br> -->
    <!-- <a href="/verify/onestore/request">Onestore Token 요청</a><br><br> -->
    <!-- <form action="/auth/guest" id="login" method="post">
        <input type="hidden" name="userid" value="<%=guest%>">
        <input type="hidden" name="username" value="guest">
    </form> -->
    <script>
    document.querySelector('#search_book').addEventListener('click', function(e) {
        console.log(1);
        e.preventDefault();
        // form 데이터 처리
        let form_element = document.querySelector('#search_book_form');
        let form_data = new FormData(form_element);
        let url = form_element.action;

        // POST fetch 실행
        fetch(url, {
            method: 'POST',
            body: form_data,
        })
        .then(response => response.json()) // response 데이터 json 처리
        .then(response => console.log(response)) // response 데이터 처리
        .catch(error => console.error);
    });
    <% if(!guest) { %>
    function makeRandomName() { // 랜덤 3글자
        let name = '';
        let possible = "abcdefghijklmnopqrstuvwxyz";
        for( let i = 0; i < 3; i++ ) {
            name += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return name;
    }
    document.querySelector('input[name="userid"]').value = makeRandomName() + Date.now();
    <% } %>
    </script>
<% } %>
</body>
</html>
